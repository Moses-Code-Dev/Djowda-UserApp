name: AI Issue Triage Gate 1
on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read
  models: read   # Required for GitHub Models

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Use GitHub Models to classify issue
        id: classify
        uses: actions/ai-inference@v1
        with:
          prompt: |
            You are triaging issues for the Djowda User App platform. Analyze this issue against our template requirements:
            
            REQUIRED for "legit" classification:
            - Issue Type must be selected (ðŸž Bug Report, âœ¨ Feature Request, or ðŸ›  Improvement)
            - Description must be clear and meaningful (not just "doesn't work" or similar)
            - Related Component must be specified (ðŸ›’ Catalog, ðŸ“¦ Orders, ðŸ‘¤ Account, ðŸ”” Notifications, âš™ï¸ Other)
            
            For BUG REPORTS specifically, also check:
            - If it's a bug, Steps to Reproduce should be provided
            - Expected vs Actual Behavior should be described
            
            SPAM indicators (mark as "not_legit"):
            - Generic/templated text unrelated to Djowda app
            - Promotional content or links
            - Nonsensical or AI-generated content
            - Empty or minimal descriptions like "fix this" or "doesn't work"
            
            Issue Title: ${{ github.event.issue.title }}
            Issue Body: ${{ github.event.issue.body }}
            
            Analyze the completeness and legitimacy. Respond with exactly one word: legit or not_legit
          system-prompt: You are a helpful assistant that triages GitHub issues for the Djowda User App. Focus on ensuring issues follow the template structure and provide sufficient detail for developers to act on.
          model: openai/gpt-4o-mini
          temperature: 0.2

      - name: Comment for legit issue
        if: contains(steps.classify.outputs.response, 'legit') && !contains(steps.classify.outputs.response, 'not_legit')
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ðŸ‘‹ Thank you for your contribution to the Djowda platform! ðŸŽ‰ Your issue has been marked as **valid**. The team will take a look soon."
            })

      - name: Add label as triaged
        if: contains(steps.classify.outputs.response, 'legit') && !contains(steps.classify.outputs.response, 'not_legit')
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['triaged']
            })
            github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'needs-info'
            }).catch(() => {})

      - name: Comment for not legit issue
        if: contains(steps.classify.outputs.response, 'not_legit')
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "âš ï¸ Thanks for opening an issue! It looks like some important details may be missing or incomplete.\n\n**Please ensure your issue includes:**\n\nâœ… **Issue Type** - Select Bug Report, Feature Request, or Improvement\nâœ… **Clear Description** - Explain the problem or idea in detail\nâœ… **Related Component** - Choose which part of the app (ðŸ›’ Catalog, ðŸ“¦ Orders, ðŸ‘¤ Account, etc.)\n\n**For Bug Reports, also include:**\nðŸ” **Steps to Reproduce** - How can we recreate the issue?\nðŸ“‹ **Expected vs Actual Behavior** - What should happen vs what actually happens?\nðŸ“± **Device Info** - Your device model and Android/iOS version\n\n*Please update your issue using our template and we'll review it promptly!*"
            })

      - name: Add label as needs-info
        if: contains(steps.classify.outputs.response, 'not_legit')
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['needs-info']
            })
            github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'triaged'
            }).catch(() => {})

      - name: Handle classification errors
        if: ${{ !contains(steps.classify.outputs.response, 'legit') && !contains(steps.classify.outputs.response, 'not_legit') }}
        uses: actions/github-script@v7
        with:
          script: |
            console.log('AI classification failed or returned unexpected result:', '${{ steps.classify.outputs.response }}')
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ðŸ¤– AI triage is temporarily unavailable. A maintainer will review this issue manually."
            })
