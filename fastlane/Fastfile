# fastlane/Fastfile

# Disables analytics
opt_out_usage

default_platform(:android)

platform :android do
  desc "Increment version, build, and deploy to internal track"
  lane :deploy_internal do

    # 1. Increment the version code using custom script
    gradle_file = "./app/build.gradle.kts"

    # Read current version code (handles comments and whitespace)
    file_content = File.read(gradle_file)
    current_version = file_content[/versionCode\s*=\s*(\d+)/, 1].to_i
    new_version = current_version + 1

    # Replace the version code
    new_content = file_content.gsub(
      /versionCode\s*=\s*\d+.*$/,
      "versionCode = #{new_version}"
    )
    File.write(gradle_file, new_content)

    UI.success("✅ Version code incremented: #{current_version} → #{new_version}")

    # 2. Build the app bundle
    gradle(
      task: "clean bundleRelease"
    )

    # 3. Upload to Play Store
    upload_to_play_store(
      track: 'internal',
      aab: './app/build/outputs/bundle/release/app-release.aab',
      json_key: '/tmp/play_store_key.json',
      package_name: 'com.djowda.djowdaUser'
    )
  end
end